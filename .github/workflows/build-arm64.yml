name: "CI: Build (arm64 Linux)"

on: [push, pull_request]

jobs:
  build:

    runs-on: ubuntu-latest

    container:
      image: dockcross/linux-arm64-full:latest

    steps:
    - uses: actions/checkout@v1
    - name: Dependencies
      run: |
        sudo apt update -y
        sudo apt install -y libsdl2-dev libasound2-dev libieee1284-3-dev
    - name: Build (SDL2/OpenGL/ALSA/ieee1284)
      working-directory: ./src
      run: |
        make WITH_ALSA=1 WITH_IEEE1284=1 COMPILER=$(CROSS_TRIPLE)
    - name: Upload (Linux aarch64)
      uses: actions/upload-artifact@v2
      with:
        name: Linux Build (aarch64)
        path: bin/
    - name: Build (Headless Test)
      working-directory: ./src
      run: |
        make clean
        make RENDERER=null DEBUG=1 COMPILER=$(CROSS_TRIPLE)
        make dumpprinter
    - name: Get Datafiles
      working-directory: ./bin
      env:
        K56DATA_URL: ${{ secrets.k56dataUrl }}
      run: |
        wget https://davidgow.net/keen/4keen14.zip
        unzip 4keen14.zip AUDIO.CK4 Gamemaps.ck4 Egagraph.ck4
        wget "$K56DATA_URL"
        unzip k56data.zip
    - name: Run Tests (Keen 4)
      working-directory: ./bin
      run: |
        ../tests/testdump.sh 0 4
        ../tests/testdump.sh 1 4
        ../tests/testdump.sh 2 4
        ../tests/testdump.sh 3 4
        ../tests/testdump.sh 4 4
    - name: Run Tests (Keen 5)
      working-directory: ./bin
      run: |
        ../tests/testdump.sh 0 5
        ../tests/testdump.sh 1 5
        ../tests/testdump.sh 2 5
        ../tests/testdump.sh 3 5
        ../tests/testdump.sh 4 5
    - name: Run Tests (Keen 6)
      working-directory: ./bin
      run: |
        ../tests/testdump.sh 0 6v14
        ../tests/testdump.sh 1 6v14
        ../tests/testdump.sh 2 6v14
        ../tests/testdump.sh 3 6v14
        ../tests/testdump.sh 4 6v14
